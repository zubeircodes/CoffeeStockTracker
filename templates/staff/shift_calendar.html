{% extends 'base.html' %}

{% block head %}
{{ super() }}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Staff Schedule</h1>
        <div>
            <a href="{{ url_for('staff.create_shift') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Shift
            </a>
            <a href="{{ url_for('staff.staff_list') }}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-users"></i> Staff Directory
            </a>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="staffFilter" class="form-label">Filter by Staff</label>
                        <select id="staffFilter" class="form-select">
                            <option value="all">All Staff</option>
                            {% for member in staff %}
                            <option value="{{ member.id }}">{{ member.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="shiftTypeFilter" class="form-label">Filter by Shift Type</label>
                        <select id="shiftTypeFilter" class="form-select">
                            <option value="all">All Types</option>
                            <option value="opening">Opening</option>
                            <option value="mid-day">Mid-Day</option>
                            <option value="closing">Closing</option>
                            <option value="special">Special Event</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Calendar container -->
            <div id="calendar"></div>
            
            <!-- Legend -->
            <div class="mt-3">
                <h5>Legend</h5>
                <div class="d-flex flex-wrap">
                    <div class="me-3 mb-2">
                        <span class="badge" style="background-color: #28a745;">&nbsp;&nbsp;&nbsp;</span> Opening
                    </div>
                    <div class="me-3 mb-2">
                        <span class="badge" style="background-color: #17a2b8;">&nbsp;&nbsp;&nbsp;</span> Mid-Day
                    </div>
                    <div class="me-3 mb-2">
                        <span class="badge" style="background-color: #6f42c1;">&nbsp;&nbsp;&nbsp;</span> Closing
                    </div>
                    <div class="me-3 mb-2">
                        <span class="badge" style="background-color: #fd7e14;">&nbsp;&nbsp;&nbsp;</span> Special Event
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize FullCalendar
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            height: 'auto',
            allDaySlot: false,
            slotMinTime: '06:00:00',
            slotMaxTime: '23:00:00',
            navLinks: true,
            editable: false,
            selectable: false,
            selectMirror: true,
            dayMaxEvents: true,
            businessHours: {
                daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                startTime: '07:00',
                endTime: '21:00',
            },
            eventClick: function(info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    return false;
                }
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                // Get shifts from API
                fetch("{{ url_for('staff.get_shifts_json') }}?start=" + fetchInfo.startStr + "&end=" + fetchInfo.endStr)
                    .then(response => response.json())
                    .then(data => {
                        // Apply filters
                        const staffFilter = document.getElementById('staffFilter').value;
                        const typeFilter = document.getElementById('shiftTypeFilter').value;
                        
                        const filteredEvents = data.filter(event => {
                            const matchesStaff = staffFilter === 'all' || event.staffId == staffFilter;
                            const matchesType = typeFilter === 'all' || event.url.includes(typeFilter);
                            return matchesStaff && matchesType;
                        });
                        
                        successCallback(filteredEvents);
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        failureCallback(error);
                    });
            }
        });
        
        calendar.render();
        
        // Filter handlers
        document.getElementById('staffFilter').addEventListener('change', function() {
            calendar.refetchEvents();
        });
        
        document.getElementById('shiftTypeFilter').addEventListener('change', function() {
            calendar.refetchEvents();
        });
    });
</script>
{% endblock %}